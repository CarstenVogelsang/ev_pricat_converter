{% extends "administration/base.html" %}
{% from "macros/breadcrumb.html" import breadcrumb %}
{% from "macros/help.html" import help_icon with context %}

{% block title %}Projektverwaltung - Administration - {{ branding.app_title }}{% endblock %}

{% block admin_content %}
{{ breadcrumb([
    {'label': 'Administration', 'url': url_for('admin.index'), 'icon': 'ti-settings'},
    {'label': 'Module', 'url': url_for('admin.module_uebersicht'), 'icon': 'ti-apps'},
    {'label': 'Projektverwaltung', 'icon': 'ti-folder'}
]) }}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="ti ti-folder text-primary"></i> Projektverwaltung</h2>
    <div class="btn-group">
        <a href="{{ url_for('projekte_admin.einstellungen') }}" class="btn btn-outline-secondary">
            <i class="ti ti-settings"></i> Einstellungen
        </a>
        <a href="{{ url_for('projekte_admin.projekt_neu') }}" class="btn btn-primary">
            <i class="ti ti-plus"></i> Neues Projekt
        </a>
    </div>
</div>

<!-- Statistik-Karten -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h3 class="mb-0">{{ stats.projekte_intern }}</h3>
                <small>Interne Projekte</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h3 class="mb-0">{{ stats.projekte_kunde }}</h3>
                <small>Kundenprojekte</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-secondary text-white">
            <div class="card-body text-center">
                <h3 class="mb-0">{{ stats.komponenten_total }}</h3>
                <small>Komponenten</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body text-center">
                <h3 class="mb-0">{{ stats.tasks_in_arbeit }}</h3>
                <small>Tasks in Arbeit</small>
            </div>
        </div>
    </div>
</div>

<!-- Projekte-Liste -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="ti ti-folder"></i> Alle Projekte ({{ projekte|length }})</span>
    </div>
    <div class="card-body p-0">
        {% if projekte %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Projekt</th>
                        <th>Typ</th>
                        <th>Komponenten</th>
                        <th>Offene Tasks</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for projekt in projekte %}
                    <tr>
                        <td>
                            <a href="{{ url_for('projekte_admin.projekt_detail', id=projekt.id) }}" class="text-decoration-none">
                                <strong>{{ projekt.name }}</strong>
                            </a>
                            {% if projekt.beschreibung %}
                            <br><small class="text-muted">{{ projekt.beschreibung[:80] }}{% if projekt.beschreibung|length > 80 %}...{% endif %}</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if projekt.typ == 'intern' %}
                            <span class="badge bg-primary">Intern</span>
                            {% else %}
                            <span class="badge bg-info">Kunde</span>
                            {% if projekt.kunde %}
                            <br><small>{{ projekt.kunde.firmierung }}</small>
                            {% endif %}
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-secondary">{{ projekt.komponenten.count() }}</span>
                        </td>
                        <td>
                            {% set total_tasks = namespace(count=0) %}
                            {% for komp in projekt.komponenten %}
                                {% set total_tasks.count = total_tasks.count + komp.anzahl_tasks %}
                            {% endfor %}
                            {% if total_tasks.count > 0 %}
                            <span class="badge bg-warning text-dark">{{ total_tasks.count }}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            <div class="btn-group btn-group-sm">
                                <a href="{{ url_for('projekte_admin.projekt_detail', id=projekt.id) }}"
                                   class="btn btn-outline-primary" title="Kanban-Board">
                                    <i class="ti ti-layout-kanban"></i>
                                </a>
                                <a href="{{ url_for('projekte_admin.projekt_bearbeiten', id=projekt.id) }}"
                                   class="btn btn-outline-secondary" title="Bearbeiten">
                                    <i class="ti ti-edit"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5 text-muted">
            <i class="ti ti-folder-off" style="font-size: 3rem;"></i>
            <p class="mt-2">Noch keine Projekte vorhanden.</p>
            <a href="{{ url_for('projekte_admin.projekt_neu') }}" class="btn btn-primary">
                <i class="ti ti-plus"></i> Erstes Projekt anlegen
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
