{% extends "administration/base.html" %}
{% from "macros/breadcrumb.html" import breadcrumb %}

{% block title %}Lieferanten - Administration - {{ branding.app_title }}{% endblock %}

{% block admin_content %}
{{ breadcrumb([
    {'label': 'Administration', 'url': url_for('admin.index'), 'icon': 'ti-settings'},
    {'label': 'Stammdaten', 'url': url_for('admin.stammdaten_uebersicht')},
    {'label': 'Lieferanten', 'icon': 'ti-truck'}
]) }}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0"><i class="ti ti-truck" style="color: #fd7e14;"></i> Lieferanten</h2>
    <div>
        <span class="badge bg-secondary me-2">{{ lieferanten|length }} Lieferanten</span>
        <a href="{{ url_for('admin.lieferant_form') }}" class="btn btn-primary btn-sm">
            <i class="ti ti-plus me-1"></i> Neu
        </a>
    </div>
</div>

{# ═══════════════════════════════════════════════════════════════════════════ #}
{# Filter- und Suchleiste #}
{# ═══════════════════════════════════════════════════════════════════════════ #}
<div class="card mb-3">
    <div class="card-body py-2">
        <form method="get" class="row g-2 align-items-center">
            {# Hauptbranche-Filter (Custom Dropdown mit Icons) #}
            <div class="col-auto">
                <div class="dropdown">
                    {# Hidden Input für Form-Submit #}
                    <input type="hidden" name="branche" id="brancheFilter" value="{{ filter_branche or '' }}">

                    {# Dropdown Button mit aktueller Auswahl #}
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle d-flex align-items-center" type="button"
                            id="brancheDropdown"
                            data-bs-toggle="dropdown"
                            data-bs-auto-close="true"
                            style="min-width: 200px;">
                        {% if filter_branche and aktuelle_branche %}
                        <i class="ti ti-{{ aktuelle_branche.icon }} me-2"></i>
                        <span class="me-auto">{{ aktuelle_branche.name }}</span>
                        {% else %}
                        <i class="ti ti-category me-2 text-muted"></i>
                        <span class="me-auto">Alle Branchen</span>
                        {% endif %}
                    </button>

                    {# Dropdown Menu #}
                    <div class="dropdown-menu p-0 shadow" style="min-width: 280px;" aria-labelledby="brancheDropdown">
                        {# Header: HANDEL (Hauptbranche) #}
                        <div class="dropdown-header bg-light border-bottom py-2">
                            <i class="ti ti-building-store me-2"></i>
                            <strong>HANDEL</strong>
                            <small class="text-muted ms-1">(Hauptbranche)</small>
                        </div>

                        {# Reset Option: Alle Branchen #}
                        <a href="#" class="dropdown-item py-2 d-flex align-items-center {{ 'active' if not filter_branche }}"
                           onclick="selectBranche('', 'Alle Branchen', 'category'); return false;">
                            <i class="ti ti-category me-2 text-muted" style="width: 24px;"></i>
                            <span>Alle Branchen</span>
                            {% if not filter_branche %}
                            <i class="ti ti-check ms-auto text-success"></i>
                            {% endif %}
                        </a>

                        <div class="dropdown-divider my-0"></div>

                        {# Branchen-Liste mit Icons #}
                        {% for branche in handel_unterbranchen %}
                        <a href="#" class="dropdown-item py-2 d-flex align-items-center {{ 'active' if filter_branche == branche.id }}"
                           onclick="selectBranche('{{ branche.id }}', '{{ branche.name }}', '{{ branche.icon }}'); return false;">
                            <i class="ti ti-{{ branche.icon }} me-2" style="width: 24px; font-size: 1.1rem;"></i>
                            <span>{{ branche.name }}</span>
                            {% if filter_branche == branche.id %}
                            <i class="ti ti-check ms-auto text-success"></i>
                            {% endif %}
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>

            {# Status-Filter #}
            <div class="col-auto">
                <select name="status" class="form-select form-select-sm"
                        onchange="this.form.submit()" style="min-width: 120px;">
                    <option value="">Alle Status</option>
                    <option value="aktiv" {{ 'selected' if filter_status == 'aktiv' }}>Aktiv</option>
                    <option value="inaktiv" {{ 'selected' if filter_status == 'inaktiv' }}>Inaktiv</option>
                </select>
            </div>

            {# Reset-Button (nur wenn Filter aktiv) #}
            {% if filter_branche or filter_status or suchbegriff %}
            <div class="col-auto">
                <a href="{{ url_for('admin.lieferanten') }}" class="btn btn-sm btn-outline-secondary">
                    <i class="ti ti-x"></i> Zurücksetzen
                </a>
            </div>
            {% endif %}

            {# Suchfeld (rechts ausgerichtet) #}
            <div class="col-auto ms-auto">
                <div class="input-group input-group-sm">
                    <span class="input-group-text"><i class="ti ti-search"></i></span>
                    <input type="text" name="q" class="form-control"
                           placeholder="Name, VEDES-ID, GLN..."
                           value="{{ suchbegriff }}"
                           style="min-width: 200px;">
                    <button type="submit" class="btn btn-primary">Suchen</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="card">
    {% if lieferanten %}
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>VEDES-ID</th>
                    <th>GLN</th>
                    <th class="text-center">Branche</th>
                    <th class="text-center">Status</th>
                    <th class="text-end">Aktionen</th>
                </tr>
            </thead>
            <tbody>
                {% for lieferant in lieferanten %}
                <tr>
                    <td><strong>{{ lieferant.kurzbezeichnung }}</strong></td>
                    <td><code>{{ lieferant.vedes_id }}</code></td>
                    <td><code>{{ lieferant.gln or '-' }}</code></td>
                    <td class="text-center">
                        {% if lieferant.hauptbranche %}
                        <i class="ti ti-{{ lieferant.hauptbranche.icon }}"
                           title="{{ lieferant.hauptbranche.name }}"
                           data-bs-toggle="tooltip"
                           style="font-size: 1.25rem; color: var(--bs-primary);"></i>
                        {% else %}
                        <span class="text-muted">—</span>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        {% if lieferant.aktiv %}
                        <span class="badge bg-success">Aktiv</span>
                        {% else %}
                        <span class="badge bg-secondary">Inaktiv</span>
                        {% endif %}
                    </td>
                    <td class="text-end">
                        <a href="{{ url_for('admin.lieferant_form', id=lieferant.id) }}"
                           class="btn btn-sm btn-outline-primary" title="Bearbeiten">
                            <i class="ti ti-edit"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="card-body text-center py-5">
        <i class="ti ti-truck-off display-1 text-muted mb-3"></i>
        <h4 class="text-muted">Keine Lieferanten vorhanden</h4>
        <p class="text-muted">
            Klicken Sie auf "Neu", um einen Lieferanten anzulegen.
        </p>
    </div>
    {% endif %}
</div>

<div class="alert alert-info mt-4">
    <i class="ti ti-info-circle me-2"></i>
    <strong>Hinweis:</strong> PRICAT-spezifische Einstellungen (FTP-Pfade, ELENA-URLs) werden über das
    <a href="{{ url_for('admin.pricat') }}">PRICAT-Converter-Modul</a> verwaltet.
</div>

{# ═══════════════════════════════════════════════════════════════════════════ #}
{# JavaScript: Tooltip-Initialisierung + Custom Dropdown #}
{# ═══════════════════════════════════════════════════════════════════════════ #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tooltips for branch icons
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));
});

/**
 * Custom Branchen-Dropdown Handler
 * Aktualisiert den Hidden Input und submitted das Form
 */
function selectBranche(id, name, icon) {
    // Hidden Input aktualisieren
    document.getElementById('brancheFilter').value = id;

    // Button-Text visuell aktualisieren (vor Submit)
    const btn = document.getElementById('brancheDropdown');
    const iconClass = icon ? `ti-${icon}` : 'ti-category';
    const iconColor = id ? '' : 'text-muted';
    btn.innerHTML = `<i class="ti ${iconClass} me-2 ${iconColor}"></i><span class="me-auto">${name}</span>`;

    // Form absenden
    btn.closest('form').submit();
}
</script>
{% endblock %}
