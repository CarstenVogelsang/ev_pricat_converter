{% extends "administration/base.html" %}

{% block title %}Vorschau: {{ template.name }} - {{ super() }}{% endblock %}

{% block admin_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <a href="{{ url_for('admin.email_template_edit', id=template.id) }}" class="text-muted text-decoration-none">
            <i class="ti ti-arrow-left"></i> {{ template.name }}
        </a>
        <h2 class="mt-2 mb-0"><i class="ti ti-eye"></i> Vorschau</h2>
    </div>
    <div class="d-flex gap-2">
        <a href="{{ url_for('admin.email_template_edit', id=template.id) }}" class="btn btn-outline-primary">
            <i class="ti ti-edit"></i> Bearbeiten
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Email Preview -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="ti ti-mail"></i>
                    {{ rendered.subject }}
                </h5>
                <span class="badge bg-info">HTML-Vorschau</span>
            </div>
            <div class="card-body p-0">
                <iframe id="emailPreview" style="width: 100%; height: 600px; border: none;"></iframe>
            </div>
        </div>

        {% if rendered.text %}
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="ti ti-file-text"></i> Plain-Text Version</h5>
                <span class="badge bg-secondary">Text-Fallback</span>
            </div>
            <div class="card-body">
                <pre class="mb-0" style="white-space: pre-wrap; font-size: 0.9rem;">{{ rendered.text }}</pre>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="col-lg-4">
        <!-- Datenquelle auswählen -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="ti ti-user"></i> Datenquelle</h5>
            </div>
            <div class="card-body">
                <label class="form-label">Kunde für Vorschau auswählen</label>
                <select class="form-select" id="kundeSelect"
                        onchange="window.location.href='?kunde_id=' + this.value">
                    <option value="">-- Beispieldaten verwenden --</option>
                    {% for k in kunden %}
                    <option value="{{ k.id }}" {% if kunde and kunde.id == k.id %}selected{% endif %}>
                        {{ k.firmierung }}{% if k.email %} ({{ k.email }}){% endif %}
                    </option>
                    {% endfor %}
                </select>
                <div class="mt-3">
                    {% if kunde %}
                    <span class="badge bg-success">
                        <i class="ti ti-user-check"></i> Echte Kundendaten
                    </span>
                    <small class="d-block mt-1 text-muted">
                        Platzhalter werden mit Daten von <strong>{{ kunde.firmierung }}</strong> befüllt.
                    </small>
                    <hr class="my-3">
                    <button type="button" class="btn btn-outline-primary btn-sm w-100"
                            data-bs-toggle="modal" data-bs-target="#testEmailModal">
                        <i class="ti ti-send"></i> Test-E-Mail senden
                    </button>
                    {% else %}
                    <span class="badge bg-secondary">
                        <i class="ti ti-test-pipe"></i> Beispieldaten
                    </span>
                    <small class="d-block mt-1 text-muted">
                        Platzhalter werden mit fiktiven Testdaten befüllt.
                    </small>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Meta Info -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="ti ti-info-circle"></i> Template-Info</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm mb-0">
                    <tr>
                        <th>Name:</th>
                        <td>{{ template.name }}</td>
                    </tr>
                    <tr>
                        <th>Schlüssel:</th>
                        <td><code>{{ template.schluessel }}</code></td>
                    </tr>
                    <tr>
                        <th>Status:</th>
                        <td>
                            {% if template.aktiv %}
                            <span class="badge bg-success">Aktiv</span>
                            {% else %}
                            <span class="badge bg-secondary">Inaktiv</span>
                            {% endif %}
                        </td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- Verwendete Daten -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="ti ti-database"></i> Verwendete Daten</h5>
            </div>
            <div class="card-body">
                {% if kunde %}
                <p class="text-muted small mb-2">Daten von <strong>{{ kunde.firmierung }}</strong>:</p>
                <table class="table table-sm mb-0">
                    <tr><td><code>firmenname</code></td><td>{{ kunde.firmierung or 'N/A' }}</td></tr>
                    <tr><td><code>briefanrede</code></td><td>{{ kunde.briefanrede }}</td></tr>
                    <tr><td><code>briefanrede_foermlich</code></td><td>{{ kunde.briefanrede_foermlich }}</td></tr>
                    <tr><td><code>briefanrede_locker</code></td><td>{{ kunde.briefanrede_locker }}</td></tr>
                    <tr><td><code>link</code></td><td class="text-muted">https://example.com/action</td></tr>
                    <tr><td><code>fragebogen_titel</code></td><td class="text-muted">Beispiel-Fragebogen</td></tr>
                    <tr><td><code>email</code></td><td>{{ kunde.email or (kunde.user.email if kunde.user else 'N/A') }}</td></tr>
                    <tr><td><code>vorname</code></td><td>{{ kunde.user.vorname if kunde.user else 'N/A' }}</td></tr>
                    <tr><td><code>nachname</code></td><td>{{ kunde.user.nachname if kunde.user else 'N/A' }}</td></tr>
                </table>
                {% else %}
                <p class="text-muted small mb-2">Die Vorschau verwendet Testdaten:</p>
                <table class="table table-sm mb-0">
                    <tr><td><code>firmenname</code></td><td>Musterfirma GmbH</td></tr>
                    <tr><td><code>briefanrede</code></td><td>Sehr geehrte Damen und Herren</td></tr>
                    <tr><td><code>briefanrede_foermlich</code></td><td>Sehr geehrte Damen und Herren</td></tr>
                    <tr><td><code>briefanrede_locker</code></td><td>Hallo zusammen</td></tr>
                    <tr><td><code>link</code></td><td>https://example.com/action</td></tr>
                    <tr><td><code>fragebogen_titel</code></td><td>Beispiel-Fragebogen</td></tr>
                    <tr><td><code>email</code></td><td>beispiel@example.com</td></tr>
                    <tr><td><code>vorname</code></td><td>Max</td></tr>
                    <tr><td><code>nachname</code></td><td>Mustermann</td></tr>
                </table>
                {% endif %}
            </div>
        </div>

        <!-- Actions -->
        <div class="d-grid gap-2">
            <a href="{{ url_for('admin.email_template_edit', id=template.id) }}" class="btn btn-primary">
                <i class="ti ti-edit"></i> Template bearbeiten
            </a>
            <a href="{{ url_for('admin.email_templates') }}" class="btn btn-outline-secondary">
                Zurück zur Liste
            </a>
        </div>
    </div>
</div>

<!-- Test-E-Mail Modal -->
{% if kunde %}
<div class="modal fade" id="testEmailModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{{ url_for('admin.email_template_send_test', id=template.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="kunde_id" value="{{ kunde.id }}">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="ti ti-send"></i> Test-E-Mail senden</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">
                        Sendet das Template mit den Daten von <strong>{{ kunde.firmierung }}</strong>.
                    </p>
                    <label class="form-label">Empfänger wählen</label>
                    <select class="form-select" name="recipient" required>
                        {% if kunde.email %}
                        <option value="kunde">{{ kunde.email }} (Kunde)</option>
                        {% endif %}
                        <option value="self">{{ current_user.email }} (An mich selbst)</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-primary"><i class="ti ti-send"></i> Senden</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<script>
// Render HTML in iframe for isolation
document.addEventListener('DOMContentLoaded', function() {
    const iframe = document.getElementById('emailPreview');
    const htmlContent = {{ rendered.html | tojson }};

    iframe.contentWindow.document.open();
    iframe.contentWindow.document.write(htmlContent);
    iframe.contentWindow.document.close();
});
</script>
{% endblock %}
