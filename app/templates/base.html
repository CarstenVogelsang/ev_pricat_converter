<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ branding.app_title }}{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts (only if web fonts are used) -->
    {% if branding.google_fonts_url %}
    <link href="{{ branding.google_fonts_url }}" rel="stylesheet">
    {% endif %}
    <link rel="stylesheet" href="{{ url_for('static', filename='tabler-icons/tabler-icons.min.css') }}">
    <style>
        :root {
            --bs-primary: {{ branding.primary_color }};
            --bs-secondary: {{ branding.secondary_color }};
        }
        html, body {
            height: 100%;
            font-family: '{{ branding.font_family }}', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        body {
            display: flex;
            flex-direction: column;
        }
        main {
            flex: 1;
        }
        .navbar-brand {
            font-weight: 600;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .navbar-brand img {
            height: 36px;
        }
        .navbar {
            background-color: {{ branding.primary_color }} !important;
        }
        /* PRD035-T058: Größere Nav-Links und bessere Lesbarkeit */
        .navbar .nav-link {
            font-size: 1.1rem;
        }
        .navbar-dark .navbar-brand,
        .navbar-dark .nav-link {
            color: {{ branding.light_text_color }} !important;
        }
        .navbar-dark .nav-link:hover {
            color: #ffffff !important;
        }
        .btn-primary {
            background-color: {{ branding.primary_color }};
            border-color: {{ branding.primary_color }};
        }
        .btn-primary:hover {
            background-color: {{ branding.primary_color }};
            border-color: {{ branding.primary_color }};
            filter: brightness(90%);
        }
        .table-hover tbody tr:hover { background-color: #f5f5f5; }
        footer {
            background-color: #f8f9fa;
            padding: 1rem 0;
            margin-top: auto;
        }
        footer a {
            color: {{ branding.primary_color }};
            text-decoration: none;
        }
        footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('main.dashboard') if current_user.is_authenticated else url_for('main.landing') }}">
                <img src="{{ branding.logo_url }}" alt="{{ branding.app_title }}">
                {{ branding.app_title }}
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    {% if current_user.is_authenticated %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.dashboard') }}">
                            <i class="ti ti-home"></i> Dashboard
                        </a>
                    </li>
                    {# PRD035-T058: Admin-Dropdown aus Top-Navigation entfernt #}
                    {% endif %}
                </ul>
                <ul class="navbar-nav">
                    {% if current_user.is_authenticated %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="ti ti-user"></i> {{ current_user.vorname }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><span class="dropdown-item-text text-muted">{{ current_user.email }}</span></li>
                            {% if current_user.is_kunde and current_user.kunde %}
                            <li><span class="dropdown-item-text">
                                <i class="ti ti-building text-muted"></i> {{ current_user.kunde.firmierung }}
                            </span></li>
                            {% endif %}
                            {% if current_user.is_kunde %}
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('abrechnung.index') }}">
                                <i class="ti ti-receipt"></i> API-Abrechnung
                            </a></li>
                            {% endif %}
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}">
                                <i class="ti ti-logout"></i> Abmelden
                            </a></li>
                        </ul>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('auth.login') }}">
                            <i class="ti ti-login"></i> Login
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Toast Container (fixed oben rechts) -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100;">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="toast align-items-center text-bg-{{ category if category in ['success', 'danger', 'warning', 'info'] else 'info' }} border-0"
                         role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="5000">
                        <div class="d-flex">
                            <div class="toast-body">{{ message }}</div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <main class="container">
        {% block content %}{% endblock %}
    </main>

    <footer>
        <div class="container text-center">
            <span class="text-muted">
                {{ branding.copyright_text }}
                {% if branding.copyright_url %}
                | <a href="{{ branding.copyright_url }}" target="_blank">e-vendo.de</a>
                {% endif %}
            </span>
        </div>
    </footer>

    <!-- Global Support Quick-Create Modal (PRD-007) -->
    {% if current_user.is_authenticated %}
    <div class="modal fade" id="supportQuickCreateModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form id="supportQuickCreateForm" method="post" action="{{ url_for('support.quick_create') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="hilfetext_schluessel" id="support_hilfetext_schluessel">
                    <input type="hidden" name="seiten_url" id="support_seiten_url">

                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="ti ti-headset text-info"></i> Support-Anfrage
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schliessen"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Kontext-Info oben anzeigen (PRD-007 UX) -->
                        <div id="support_kontext_info" class="alert alert-info py-2 d-none">
                            <i class="ti ti-link"></i> <strong>Kontext:</strong> <span id="support_kontext_text"></span>
                        </div>
                        <div class="mb-3">
                            <label for="support_typ" class="form-label">Anfrage-Typ</label>
                            <select class="form-select" id="support_typ" name="typ" required>
                                <option value="frage">Frage</option>
                                <option value="verbesserung">Verbesserungsvorschlag</option>
                                <option value="bug">Fehlermeldung</option>
                                <option value="schulung">Schulungsanfrage</option>
                                <option value="daten">Datenkorrektur</option>
                                <option value="sonstiges">Sonstiges</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="support_titel" class="form-label">Betreff *</label>
                            <input type="text" class="form-control" id="support_titel" name="titel"
                                   maxlength="200" required placeholder="Worum geht es?">
                        </div>
                        <div class="mb-3">
                            <label for="support_beschreibung" class="form-label">Beschreibung *</label>
                            <textarea class="form-control" id="support_beschreibung" name="beschreibung"
                                      rows="4" required placeholder="Beschreiben Sie Ihr Anliegen..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="ti ti-send"></i> Anfrage senden
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Toasts automatisch anzeigen
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.toast').forEach(function(toastEl) {
                new bootstrap.Toast(toastEl).show();
            });
        });

        // Support Quick-Create Modal (PRD-007)

        // Mapping für lesbare Kontext-Namen
        const kontextLabels = {
            // Module
            'kunden': 'Kunden',
            'dialog': 'Kunden-Dialog',
            'pricat': 'PRICAT Converter',
            'admin': 'Administration',
            'support': 'Support',
            'abrechnung': 'Abrechnung',
            // Ansichten
            'index': 'Übersicht',
            'detail': 'Detail',
            'form': 'Formular',
            'liste': 'Liste',
            'neu': 'Neu',
            'edit': 'Bearbeiten',
            // Bereiche/Elemente
            'stammdaten': 'Stammdaten',
            'branchen': 'Branchen',
            'verbaende': 'Verbände',
            'ci': 'Corporate Identity',
            'benutzer': 'Benutzer',
            'einstellungen': 'Einstellungen',
            'uebersicht': 'Übersicht',
            'fragebogen': 'Fragebogen',
            'teilnehmer': 'Teilnehmer',
            'auswertung': 'Auswertung'
        };

        // Konvertiert einen Schlüssel wie "kunden.detail.stammdaten" in einen Breadcrumb
        function formatKontextBreadcrumb(schluessel) {
            if (!schluessel) return '';

            const teile = schluessel.split('.');
            const lesbar = teile.map(function(teil) {
                // Erst im Mapping suchen, sonst kapitalisieren
                if (kontextLabels[teil.toLowerCase()]) {
                    return kontextLabels[teil.toLowerCase()];
                }
                // Fallback: Erster Buchstabe groß
                return teil.charAt(0).toUpperCase() + teil.slice(1);
            });

            return lesbar.join(' › ');
        }

        function openSupportModal(hilfetextSchluessel, hilfetextTitel) {
            // Set hidden fields
            document.getElementById('support_hilfetext_schluessel').value = hilfetextSchluessel || '';
            document.getElementById('support_seiten_url').value = window.location.href;

            // Reset form
            document.getElementById('support_titel').value = '';
            document.getElementById('support_beschreibung').value = '';
            document.getElementById('support_typ').value = 'frage';

            // Show context info as breadcrumb if available
            const kontextInfo = document.getElementById('support_kontext_info');
            const kontextText = document.getElementById('support_kontext_text');
            if (hilfetextSchluessel) {
                // Breadcrumb aus Schlüssel generieren
                kontextText.innerHTML = formatKontextBreadcrumb(hilfetextSchluessel);
                kontextInfo.classList.remove('d-none');
            } else {
                kontextInfo.classList.add('d-none');
            }

            // Close any open help modal first
            const openModals = document.querySelectorAll('.modal.show');
            openModals.forEach(function(modal) {
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) bsModal.hide();
            });

            // Open support modal after a brief delay
            setTimeout(function() {
                const supportModal = new bootstrap.Modal(document.getElementById('supportQuickCreateModal'));
                supportModal.show();
            }, 150);
        }
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>
