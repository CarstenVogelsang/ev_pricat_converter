{% extends "administration/base.html" %}
{% from "macros/breadcrumb.html" import breadcrumb %}

{% block title %}{{ ticket.nummer_intern }} - Support{% endblock %}

{% block admin_content %}
{{ breadcrumb([
    {'label': 'Administration', 'url': url_for('admin.index'), 'icon': 'ti-settings'},
    {'label': 'Support-Tickets', 'url': url_for('support_admin.dashboard'), 'icon': 'ti-headset'},
    {'label': ticket.nummer_intern}
]) }}

<div class="row">
    <div class="col-lg-8">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-start mb-4">
            <div>
                <h4 class="mb-2">
                    <span class="badge bg-light text-dark me-2" title="Kunden sehen: {{ ticket.nummer_anzeige }}">{{ ticket.nummer_intern }}</span>
                    {{ ticket.titel }}
                </h4>
                <div>
                    <span class="badge bg-{{ ticket.status_color }} me-2">{{ ticket.status_label }}</span>
                    <span class="badge bg-{{ ticket.prioritaet_color }} me-2">{{ ticket.prioritaet_label }}</span>
                    <span class="badge bg-light text-dark">
                        <i class="{{ ticket.typ_icon }}"></i> {{ ticket.typ_label }}
                    </span>
                </div>
            </div>
        </div>

        <!-- Beschreibung -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="ti ti-file-description"></i> Beschreibung
            </div>
            <div class="card-body">
                <div class="markdown-content">
                    {{ ticket.beschreibung|markdown|safe }}
                </div>
            </div>
            <div class="card-footer text-muted small">
                Erstellt von <strong>{{ ticket.ersteller.vorname }} {{ ticket.ersteller.nachname }}</strong>
                am {{ ticket.erstellt_am.strftime('%d.%m.%Y um %H:%M Uhr') }}
            </div>
        </div>

        <!-- Kommentare -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="ti ti-messages"></i> Verlauf ({{ kommentare|length }})
            </div>
            <div class="card-body">
                {% if kommentare %}
                <div class="timeline">
                    {% for kommentar in kommentare %}
                    <div class="timeline-item mb-3 pb-3 {{ 'border-bottom' if not loop.last else '' }}
                                {{ 'bg-light rounded p-2 mx-n2' if kommentar.ist_intern else '' }}">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <strong>{{ kommentar.user.vorname }} {{ kommentar.user.nachname }}</strong>
                                {% if kommentar.user.is_admin or kommentar.user.is_mitarbeiter %}
                                <span class="badge bg-info ms-1">Support</span>
                                {% endif %}
                                {% if kommentar.ist_intern %}
                                <span class="badge bg-dark ms-1">Intern</span>
                                {% endif %}
                                {% if kommentar.ist_status_aenderung %}
                                <span class="badge bg-secondary ms-1">Status</span>
                                {% endif %}
                            </div>
                            <small class="text-muted">{{ kommentar.erstellt_am.strftime('%d.%m.%Y %H:%M') }}</small>
                        </div>
                        <div class="{% if kommentar.ist_status_aenderung %}text-muted fst-italic{% endif %}">
                            {{ kommentar.inhalt|markdown|safe }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted mb-0">Noch keine Kommentare.</p>
                {% endif %}
            </div>
        </div>

        <!-- Neuer Kommentar -->
        {% if ticket.status != TicketStatus.GESCHLOSSEN.value %}
        <div class="card">
            <div class="card-header">
                <i class="ti ti-message-plus"></i> Kommentar hinzufügen
            </div>
            <div class="card-body">
                <form method="post">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="kommentar">
                    <div class="mb-3">
                        <textarea class="form-control" name="inhalt" rows="4"
                                  placeholder="Ihre Nachricht..." required></textarea>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="ist_intern" value="1" id="ist_intern">
                            <label class="form-check-label" for="ist_intern">
                                Interner Kommentar (nur für Team sichtbar)
                            </label>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="ti ti-send"></i> Senden
                        </button>
                    </div>
                </form>
            </div>
        </div>
        {% else %}
        <div class="alert alert-secondary">
            <i class="ti ti-lock"></i>
            Dieses Ticket ist geschlossen.
        </div>
        {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Details -->
        <div class="card mb-3">
            <div class="card-header">
                <i class="ti ti-info-circle"></i> Details
            </div>
            <div class="card-body">
                <table class="table table-sm table-borderless mb-0">
                    <tr>
                        <td class="text-muted">Ticket-Nr:</td>
                        <td>
                            <strong>{{ ticket.nummer_intern }}</strong>
                            <small class="text-muted ms-1">(Kunde sieht: {{ ticket.nummer_anzeige }})</small>
                        </td>
                    </tr>
                    <tr>
                        <td class="text-muted">Ersteller:</td>
                        <td>{{ ticket.ersteller.vorname }} {{ ticket.ersteller.nachname }}</td>
                    </tr>
                    {% if ticket.kunde %}
                    <tr>
                        <td class="text-muted">Kunde:</td>
                        <td>{{ ticket.kunde.name }}</td>
                    </tr>
                    {% endif %}
                    {% if ticket.modul %}
                    <tr>
                        <td class="text-muted">Modul:</td>
                        <td>{{ ticket.modul.name }}</td>
                    </tr>
                    {% endif %}
                    <tr>
                        <td class="text-muted">Erstellt:</td>
                        <td>{{ ticket.erstellt_am.strftime('%d.%m.%Y %H:%M') }}</td>
                    </tr>
                    {% if ticket.geloest_am %}
                    <tr>
                        <td class="text-muted">Gelöst:</td>
                        <td>{{ ticket.geloest_am.strftime('%d.%m.%Y %H:%M') }}</td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>

        <!-- Status ändern -->
        <div class="card mb-3">
            <div class="card-header">
                <i class="ti ti-switch"></i> Status ändern
            </div>
            <div class="card-body">
                <form method="post">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="status">
                    <div class="mb-3">
                        <select name="neuer_status" class="form-select form-select-sm">
                            {% for status in TicketStatus %}
                            <option value="{{ status.value }}"
                                    {{ 'selected' if ticket.status == status.value else '' }}>
                                {{ status.get_label(status.value) }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <input type="text" name="status_kommentar" class="form-control form-control-sm"
                               placeholder="Optionaler Kommentar...">
                    </div>
                    <button type="submit" class="btn btn-outline-primary btn-sm w-100">
                        <i class="ti ti-check"></i> Status ändern
                    </button>
                </form>
            </div>
        </div>

        <!-- Bearbeiter zuweisen -->
        <div class="card mb-3">
            <div class="card-header">
                <i class="ti ti-user-plus"></i> Bearbeiter zuweisen
            </div>
            <div class="card-body">
                <form method="post">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="assign">
                    <div class="mb-3">
                        <select name="bearbeiter_id" class="form-select form-select-sm">
                            <option value="">-- Nicht zugewiesen --</option>
                            {% for member in team_members %}
                            <option value="{{ member.id }}"
                                    {{ 'selected' if ticket.bearbeiter_id == member.id else '' }}>
                                {{ member.vorname }} {{ member.nachname }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="btn btn-outline-primary btn-sm w-100">
                        <i class="ti ti-check"></i> Zuweisen
                    </button>
                </form>
            </div>
        </div>

        <!-- Priorität ändern -->
        <div class="card mb-3">
            <div class="card-header">
                <i class="ti ti-flag"></i> Priorität ändern
            </div>
            <div class="card-body">
                <form method="post">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="prioritaet">
                    <div class="mb-3">
                        <select name="neue_prioritaet" class="form-select form-select-sm">
                            {% for prio in TicketPrioritaet %}
                            <option value="{{ prio.value }}"
                                    {{ 'selected' if ticket.prioritaet == prio.value else '' }}>
                                {{ prio.get_label(prio.value) }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="btn btn-outline-primary btn-sm w-100">
                        <i class="ti ti-check"></i> Ändern
                    </button>
                </form>
            </div>
        </div>

        <!-- Kontext -->
        {% if ticket.hilfetext_schluessel or ticket.seiten_url %}
        <div class="card">
            <div class="card-header">
                <i class="ti ti-link"></i> Kontext
            </div>
            <div class="card-body">
                {% if ticket.hilfetext_schluessel %}
                <div class="mb-2">
                    <small class="text-muted">Hilfetext:</small><br>
                    <code>{{ ticket.hilfetext_schluessel }}</code>
                </div>
                {% endif %}
                {% if ticket.seiten_url %}
                <div>
                    <small class="text-muted">Seite:</small><br>
                    <a href="{{ ticket.seiten_url }}" target="_blank" class="small text-break">
                        {{ ticket.seiten_url|truncate(40) }}
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
