{% extends "base.html" %}
{% from "macros/breadcrumb.html" import breadcrumb %}

{% block title %}{{ mailing.titel }} - {{ super() }}{% endblock %}

{% block content %}
<div class="container py-4">
    {{ breadcrumb([
        {'label': 'Dashboard', 'url': url_for('main.dashboard'), 'icon': 'ti-home'},
        {'label': 'Kunden-Mailing', 'url': url_for('mailing_admin.index'), 'icon': 'ti-mail'},
        {'label': mailing.titel}
    ]) }}

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0">
                <i class="ti ti-mail"></i> {{ mailing.titel }}
            </h2>
            <p class="text-muted mb-0 mt-1">
                <span class="badge bg-{{ 'secondary' if mailing.is_entwurf else 'success' }}">
                    {{ 'Entwurf' if mailing.is_entwurf else 'Versendet' }}
                </span>
                &middot; Erstellt am {{ mailing.erstellt_am.strftime('%d.%m.%Y %H:%M') }}
            </p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('mailing_admin.vorschau', id=mailing.id) }}" class="btn btn-outline-info">
                <i class="ti ti-eye"></i> Vorschau
            </a>
            {% if not mailing.is_entwurf %}
            <a href="{{ url_for('mailing_admin.statistik', id=mailing.id) }}" class="btn btn-outline-success">
                <i class="ti ti-chart-bar"></i> Statistik
            </a>
            {% endif %}
            {% if mailing.is_entwurf %}
            <a href="{{ url_for('mailing_admin.editor', id=mailing.id) }}" class="btn btn-outline-primary">
                <i class="ti ti-layout"></i> Editor
            </a>
            <a href="{{ url_for('mailing_admin.empfaenger', id=mailing.id) }}" class="btn btn-outline-secondary">
                <i class="ti ti-users"></i> Empfänger ({{ mailing.empfaenger|length }})
            </a>
            <a href="{{ url_for('mailing_admin.edit', id=mailing.id) }}" class="btn btn-primary">
                <i class="ti ti-edit"></i> Bearbeiten
            </a>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Mailing Info -->
            <div class="card mb-4">
                <div class="card-header">
                    <span><i class="ti ti-info-circle"></i> Mailing-Details</span>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-3">Betreff</dt>
                        <dd class="col-sm-9">{{ mailing.betreff }}</dd>

                        <dt class="col-sm-3">Sektionen</dt>
                        <dd class="col-sm-9">
                            {% if mailing.sektionen %}
                            <ul class="list-unstyled mb-0">
                                {% for s in mailing.sektionen %}
                                <li>
                                    <span class="badge bg-light text-dark">{{ s.typ }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                            {% else %}
                            <span class="text-muted">Keine Sektionen definiert</span>
                            {% endif %}
                        </dd>

                        {% if mailing.fragebogen %}
                        <dt class="col-sm-3">Verlinkter Fragebogen</dt>
                        <dd class="col-sm-9">
                            <a href="{{ url_for('dialog_admin.detail', id=mailing.fragebogen_id) }}">
                                <i class="ti ti-link"></i> {{ mailing.fragebogen.titel }}
                            </a>
                        </dd>
                        {% endif %}

                        <dt class="col-sm-3">Erstellt von</dt>
                        <dd class="col-sm-9">{{ mailing.erstellt_von.full_name if mailing.erstellt_von else 'Unbekannt' }}</dd>
                    </dl>
                </div>
            </div>

            <!-- Empfänger-Übersicht -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="ti ti-users"></i> Empfänger</span>
                    {% if mailing.is_entwurf %}
                    <a href="{{ url_for('mailing_admin.empfaenger', id=mailing.id) }}" class="btn btn-sm btn-outline-primary">
                        <i class="ti ti-edit"></i> Verwalten
                    </a>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if mailing.empfaenger %}
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>Kunde</th>
                                    <th>E-Mail</th>
                                    <th class="text-center">Status</th>
                                    <th class="text-center">Klicks</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for e in mailing.empfaenger[:10] %}
                                <tr>
                                    <td>{{ e.kunde.firmierung }}</td>
                                    <td class="text-muted">{{ e.kunde.kontakt_email }}</td>
                                    <td class="text-center">
                                        {% if e.is_versendet %}
                                        <span class="badge bg-success">Versendet</span>
                                        {% elif e.is_fehlgeschlagen %}
                                        <span class="badge bg-danger" title="{{ e.fehler_meldung }}">Fehler</span>
                                        {% else %}
                                        <span class="badge bg-secondary">Ausstehend</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {{ e.anzahl_klicks if e.anzahl_klicks > 0 else '-' }}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if mailing.empfaenger|length > 10 %}
                    <div class="text-center mt-2">
                        <a href="{{ url_for('mailing_admin.empfaenger', id=mailing.id) }}">
                            ... und {{ mailing.empfaenger|length - 10 }} weitere
                        </a>
                    </div>
                    {% endif %}
                    {% else %}
                    <p class="text-muted mb-0">Noch keine Empfänger hinzugefügt.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Statistik -->
            <div class="card mb-4">
                <div class="card-header">
                    <span><i class="ti ti-chart-bar"></i> Statistik</span>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="h2 mb-0">{{ mailing.empfaenger|length }}</div>
                            <small class="text-muted">Empfänger</small>
                        </div>
                        <div class="col-4">
                            <div class="h2 mb-0 text-success">{{ mailing.anzahl_versendet }}</div>
                            <small class="text-muted">Versendet</small>
                        </div>
                        <div class="col-4">
                            <div class="h2 mb-0 text-primary">{{ mailing.anzahl_klicks }}</div>
                            <small class="text-muted">Klicks</small>
                        </div>
                    </div>

                    {% if mailing.anzahl_fehlgeschlagen > 0 %}
                    <hr>
                    <div class="text-danger text-center">
                        <i class="ti ti-alert-triangle"></i>
                        {{ mailing.anzahl_fehlgeschlagen }} fehlgeschlagen
                    </div>
                    {% endif %}

                    {% if mailing.is_versendet and mailing.anzahl_versendet > 0 %}
                    <hr>
                    <div class="text-center">
                        <div class="h4 mb-0">{{ "%.1f"|format(mailing.klickrate) }}%</div>
                        <small class="text-muted">Klickrate</small>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Aktionen -->
            {% if mailing.is_entwurf %}
            <div class="card">
                <div class="card-header">
                    <span><i class="ti ti-send"></i> Versand</span>
                </div>
                <div class="card-body">
                    {% if mailing.empfaenger|length == 0 %}
                    <div class="alert alert-warning mb-0">
                        <i class="ti ti-info-circle"></i>
                        Bitte zuerst Empfänger hinzufügen.
                    </div>
                    {% elif mailing.anzahl_sektionen == 0 %}
                    <div class="alert alert-warning mb-0">
                        <i class="ti ti-info-circle"></i>
                        Bitte zuerst Inhalt (Sektionen) hinzufügen.
                    </div>
                    {% else %}
                    <p class="mb-3">
                        {{ mailing.empfaenger|length }} Empfänger bereit zum Versand.
                    </p>
                    <a href="{{ url_for('mailing_admin.senden', id=mailing.id) }}" class="btn btn-success w-100">
                        <i class="ti ti-send"></i> Jetzt versenden
                    </a>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
